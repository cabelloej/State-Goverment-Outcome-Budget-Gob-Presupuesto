*** CALCULA TODOS LOS TOTALES DE LAS OPERACIONES SELECCIONADAS
*** Y NO DE LOS ACUMULADORES DE DE CADA REGISTRO DEL PLAN DE CTAS.

SAVE SCRE TO WSCREMO
SELECT 1
USE PRPARTI  INDEX PRPARTI
SELECT 2
USE PRCTAS   INDEX PRCTAS1
SELECT 3
USE PRTRAS   INDEX PRTRAS1,PRTRAS2
SELECT 4
USE PRINCRE  INDEX PRINCRE
SELECT 5
USE PRDISMI  INDEX PRDISMI
SELECT 6
USE PRCOMP   INDEX PRCOMP1
SELECT 7
USE PRPAGA   INDEX PRPAGA1

STORE DATE() TO WHASTA
STORE .F.    TO WFLAGCON
DO WHILE .T.
   @ 00,00 clear
   @ 04,00                to 17,40
   @ 04,01 SAY " MOVIMIENTOS X PARTIDA "

   @ 06,01 SAY "A¥O      :"
   @ 08,01 SAY "ORIGEN   :"
   @ 10,01 SAY "PARTIDA  :"
   @ 12,01 SAY "HASTA    :"

   @ 06,12 GET WPREANO
   @ 08,12 GET WPREORI
   @ 10,12 GET WPARTID PICT "#.##"
   @ 10,17 GET WGENERI
   @ 10,20 GET WESPECI
   @ 10,23 GET WSUBESP
   @ 10,26 GET WORDINA
   READ
   IF LASTKEY() = 27
      EXIT
   ENDIF
   STORE SPACE(18) TO WCUENTA0
   DO WARMACOD0
   IF AT(" ",WCUENTA0) > 0
      STORE "NO DEBEN EXISTIR ESPACIOS EN BLANCO DENTRO DEL CODIGO" TO MES
      DO AVISO WITH MES
      LOOP
   ENDIF
   IF (LEN(WCUENTA0) <> LEN(LTRIM(RTRIM(WCUENTA0))))
      STORE "ESPACIO EN BLANCO INVALIDO A LA IZQUIERDA O A LA DERECHA DEL CODIGO, VERIFIQUE" TO MES
      DO AVISO WITH MES
      LOOP
   ENDIF
   SELECT PRCTAS
   SEEK WCUENTA0
   IF .NOT. FOUND()
      STORE "CODIGO DE PARTIDA "+WCUENTA0+" NO REGISTRADO EN PRESUPUESTO, VERIFIQUE" TO MES
      DO AVISO WITH MES
      LOOP
   ENDIF
   @ 12,12 GET WHASTA
   READ
   store "SELECCIONE LA SALIDA: (M)ONITOR, (I)MPRESORA, (S)ALIR" TO TEX
   STORE "MIS" TO WCH
   DO PREGUNTA
   STORE WCH TO WSALIDA
   IF WSALIDA = "S"
      EXIT
   ENDIF
   IF WSALIDA = "I"
      SET DEVI TO PRINT
      STORE 55 TO WSALTO
      STORE 80 TO WCADENA
   ELSE
      SET DEVI TO SCRE
      STORE 20 TO WSALTO
      STORE 80 TO WCADENA
   ENDIF
   STORE 100 to wline
   STORE 0   to wpage


   STORE WLINE+1 TO WLINE
   DO CONTROL
   @ WLINE,00 SAY "ASIGNACION ORIGINAL:"
   @ WLINE,63 SAY PRCTAS.ORIG PICT "99,999,999,999.99"
   STORE WLINE+1 TO WLINE

   ***
   *** TRASPASOS A FAVOR
   ***
   STORE 0 TO WTRASMES
   STORE WLINE+1 TO WLINE
   DO CONTROL
   DO HEADTRAS
   SELECT PRTRAS
   SET ORDER TO PRTRAS2
   SEEK WCUENTA0
   DO WHILE .NOT.EOF().AND.DESTINO=WCUENTA0
      IF FECHA<=WHASTA
         STORE WLINE+1 TO WLINE
         DO CONTROL
         IF WFLAGCON
            DO HEADTRAS
            STORE WLINE+1 TO WLINE
         ENDIF
         @ WLINE,00 SAY ORIGEN
         @ WLINE,41 SAY FECHA
         @ WLINE,52 SAY OFICIO
         @ WLINE,63 SAY MONTO PICT "99,999,999,999.99"
         STORE WTRASMES+MONTO TO WTRASMES
      ENDIF
      SKIP
   ENDDO
   ***
   *** TRASPASOS EN CONTRA
   ***
   SELECT PRTRAS
   SET ORDER TO PRTRAS1
   SEEK WCUENTA0
   DO WHILE .NOT.EOF().AND.ORIGEN=WCUENTA0
      IF FECHA<=WHASTA
         STORE WLINE+1 TO WLINE
         DO CONTROL
         IF WFLAGCON
            DO HEADTRAS
            STORE WLINE+1 TO WLINE
         ENDIF
         @ WLINE,00 SAY DESTINO
         @ WLINE,41 SAY FECHA
         @ WLINE,52 SAY OFICIO
         @ WLINE,63 SAY MONTO*-1 PICT "99,999,999,999.99"
         STORE WTRASMES-MONTO TO WTRASMES
      ENDIF
      SKIP
   ENDDO
   STORE WLINE+1 TO WLINE
   DO CONTROL
   IF WFLAGCON
      DO HEADTRAS
   ENDIF
   @ WLINE,52 SAY "TOTAL :"
   @ WLINE,63 SAY WTRASMES PICT "99,999,999,999.99"
   ***
   *** INCREMENTOS
   ***
   STORE 0 TO WINCREMES
   STORE WLINE+1 TO WLINE
   DO CONTROL
   DO HEADINCRE
   SELECT PRINCRE
   SEEK WCUENTA0
   DO WHILE.NOT.EOF().AND.;
      PREANO+PREORI+PARTID+GENERI+ESPECI+SUBESP+ORDINA=WCUENTA0
      IF FECHA<=WHASTA
         STORE WLINE+1 TO WLINE
         DO CONTROL
         IF WFLAGCON
            DO HEADINCRE
            STORE WLINE+1 TO WLINE
         ENDIF
         STORE  PARTID+"."+GENERI+"."+ESPECI+"."+SUBESP+"."+ORDINA TO WCODIGO
         @ WLINE,00 SAY WCODIGO
         @ WLINE,41 SAY FECHA
         *@ WLINE,52 SAY OFICIO
         @ WLINE,63 SAY MONTO PICT "99,999,999,999.99"
         STORE WINCREMES+MONTO TO WINCREMES
      ENDIF
      SKIP
   ENDDO
   STORE WLINE+1 TO WLINE
   DO CONTROL
   IF WFLAGCON
      DO HEADINCR
   ENDIF
   @ WLINE,52 SAY "TOTAL :"
   @ WLINE,63 SAY WINCREMES PICT "99,999,999,999.99"
   ***
   *** DISMINUCIONES
   ***
   STORE 0 TO WDISMIMES
   STORE WLINE+1 TO WLINE
   DO CONTROL
   DO HEADDISMI
   SELECT PRDISMI
   SET ORDER TO PRDISMI
   SEEK WCUENTA0
   DO WHILE.NOT.EOF().AND.;
      PREANO+PREORI+PARTID+GENERI+ESPECI+SUBESP+ORDINA=WCUENTA0
      IF FECHA<=WHASTA
         STORE WLINE+1 TO WLINE
         DO CONTROL
         IF WFLAGCON
            DO HEADDISMI
            STORE WLINE+1 TO WLINE
         ENDIF
         STORE  PARTID+"."+GENERI+"."+ESPECI+"."+SUBESP+"."+ORDINA TO WCODIGO
         @ WLINE,00 SAY WCODIGO
         @ WLINE,41 SAY FECHA
         *@ WLINE,52 SAY OFICIO
         @ WLINE,63 SAY MONTO PICT "99,999,999,999.99"
         STORE WDISMIMES+MONTO TO WDISMIMES
      ENDIF
      SKIP
   ENDDO
   STORE WLINE+1 TO WLINE
   DO CONTROL
   IF WFLAGCON
      DO HEADDISMI
   ENDIF
   @ WLINE,52 SAY "TOTAL :"
   @ WLINE,63 SAY WDISMIMES PICT "99,999,999,999.99"
   ***
   *** COMPROMISOS
   ***
   STORE 0 TO WCOMPRMES
   STORE WLINE+1 TO WLINE
   DO CONTROL
   DO HEADCOMPR
   SELECT PRCOMP
   SET ORDER TO PRCOMP1
   SEEK WCUENTA0
   DO WHILE.NOT.EOF().AND.CODIGOPRE=WCUENTA0
      IF FECHA<=WHASTA
         STORE WLINE+1 TO WLINE
         DO CONTROL
         IF WFLAGCON
            DO HEADCOMPR
            STORE WLINE+1 TO WLINE
         ENDIF
         @ WLINE,00 SAY "BENEFICIARIO: "+BENEFI
         @ WLINE,41 SAY FECHA
         @ WLINE,52 SAY SOPORTE
         @ WLINE,63 SAY MONTO PICT "99,999,999,999.99"
         STORE WCOMPRMES+MONTO TO WCOMPRMES
      ENDIF
      SKIP
   ENDDO
   STORE WLINE+1 TO WLINE
   DO CONTROL
   IF WFLAGCON
      DO HEADCOMPR
   ENDIF
   @ WLINE,52 SAY "TOTAL :"
   @ WLINE,63 SAY WCOMPRMES PICT "99,999,999,999.99"
   ***
   *** PAGOS
   ***
   STORE 0 TO WPAGOSMES
   STORE WLINE+1 TO WLINE
   DO CONTROL
   DO HEADPAGOS
   SELECT PRPAGA
   SET ORDER TO PRPAGA1
   SEEK WCUENTA0
   DO WHILE.NOT.EOF().AND.CODIGOPRE=WCUENTA0
      IF FECHAPAGA<=WHASTA
         STORE WLINE+1 TO WLINE
         DO CONTROL
         IF WFLAGCON
            DO HEADPAGOS
            STORE WLINE+1 TO WLINE
         ENDIF
         @ WLINE,00 SAY "COMPROMISO: "+CONTRATO
         @ WLINE,41 SAY FECHAPAGA
         @ WLINE,52 SAY RECIBO
         @ WLINE,63 SAY MONTOPAGA PICT "99,999,999,999.99"
         STORE WPAGOSMES+MONTOPAGA TO WPAGOSMES
      ENDIF
      SKIP
   ENDDO
   STORE WLINE+1 TO WLINE
   DO CONTROL
   IF WFLAGCON
      DO HEADPAGOS
   ENDIF
   @ WLINE,52 SAY "TOTAL :"
   @ WLINE,63 SAY WPAGOSMES PICT "99,999,999,999.99"

   STORE 100 TO WLINE
   DO CONTROL
   @ 12,00 SAY "ASIGNACION ORIGINAL .............. Bs. "
   @ 12,40 SAY PRCTAS.ORIG PICTURE "999,999,999,999.99"
   @ 13,00 SAY "TRASPASOS ........................ Bs. "
   @ 13,40 SAY WTRASMES PICTURE "999,999,999,999.99"
   @ 14,00 SAY "INCREMENTOS ...................... Bs. "
   @ 14,40 SAY WINCREMES PICTURE "999,999,999,999.99"
   @ 15,00 SAY "DISMINUCIONES .................... Bs. "
   @ 15,40 SAY WDISMIMES PICTURE "999,999,999,999.99"
   @ 16,00 SAY "MODIFICADO ....................... Bs. "
   STORE PRCTAS.ORIG+WTRASMES+WINCREMES-WDISMIMES           TO WMODIFI
   @ 16,40 SAY WMODIFI PICTURE "999,999,999,999.99"
   @ 17,00 SAY "COMPROMISOS ...................... Bs. "
   @ 17,40 SAY WCOMPRMES PICTURE "999,999,999,999.99"
   @ 18,00 SAY "PAGOS ............................ Bs. "
   @ 18,40 SAY WPAGOSMES PICTURE "999,999,999,999.99"
   @ 19,00 SAY "PENDIENTE  POR PAGAR ............. Bs. "
   STORE WCOMPRMES-WPAGOSMES                                TO WPENDIMES
   @ 19,40 SAY WPENDIMES PICTURE "999,999,999,999.99"
   @ 20,00 SAY "DISPONIBLE POR COMPROMETER ....... Bs. "
   STORE WMODIFI-WCOMPRMES                                 TO WDISPOMES
   @ 20,40 SAY WDISPOMES PICTURE "999,999,999,999.99"

   IF WSALIDA = "M"
      store "OPRIMA <ENTER> PARA SALIR" TO MES
      DO AVISO WITH MES
   ELSE
      set devi to scre
      EJECT
   ENDIF
ENDDO
DO FIN
************
PROC CONTROL
************
IF wline > WSALTO
   STORE .T. TO WFLAGCON
   STORE WPAGE + 1 TO WPAGE
   if wpage > 1 .AND. WSALIDA = "M"
      store "OPRIMA <ENTER> PARA CONTINUAR" TO MES
      DO AVISO WITH MES
   endif
   DO HEADER
ELSE
   STORE .F. TO WFLAGCON
ENDIF
************
PROC HEADER
************
@ 00,00 clear
@ 01,00 say rtrim(qqww)
@ 01,Wcadena-16 say "FECHA :"+DTOC(DATE())
@ 02,00 say "MOVIMIENTOS POR PARTIDA"
@ 02,WCADENA-16 SAY "PAGINA:"+STR(WPAGE,3)
@ 03,00 say "HASTA EL   : "+DTOC(WHASTA)
@ 03,40 say "PRESUPUESTO: "+WPREANO+"."+WPREORI
@ 04,00 SAY "PARTIDA    : "+WPARTID+"."+WGENERI+"."+WESPECI+"."+WSUBESP+"."+WORDINA
@ 05,13 SAY PRCTAS.DESCRI1
@ 06,13 SAY PRCTAS.DESCRI2
@ 07,13 SAY PRCTAS.DESCRI3
@ 08,13 SAY PRCTAS.DESCRI4
@ 09,00 SAY "----------------------------------------+----------+----------+-----------------"
@ 10,00 SAY "REFERENCIA DE LA OPERACION              |FECHA     |DOCUMENTO |            MONTO"
@ 11,00 SAY "----------------------------------------+----------+----------+-----------------"
STORE 12 TO WLINE
RETURN
*************
PROC HEADTRAS
*************
@ WLINE,00 SAY "T R A S P A S O S"
RETURN
*************
PROC HEADINCRE
*************
@ WLINE,00 SAY "I N C R E M E N T O S"
RETURN
*************
PROC HEADDISMI
*************
@ WLINE,00 SAY "D I S M I N U C I O N E S :"
RETURN
*************
PROC HEADCOMPR
*************
@ WLINE,00 SAY "C O M P R O M I S O S :"
RETURN
*************
PROC HEADPAGOS
*************
@ WLINE,00 SAY "P A G O S :"
RETURN
************
PROC FIN
************
CLOSE DATA
CLOSE INDEX
RESTORE SCRE FROM WSCREMO
RETURN TO PRMENU
